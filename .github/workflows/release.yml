name: Build & Release Multi-Platform

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string (e.g. "1.1.0"). Leave empty to use current version from pubspec.yaml.'
        required: false
        default: ''
      build_notes:
        description: 'Release notes text'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      build_number: ${{ steps.extract.outputs.build_number }}
      tag: ${{ steps.extract.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract or update version
        id: extract
        working-directory: ./mobile
        run: |
          CURRENT=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          CURRENT_VERSION=$(echo "$CURRENT" | cut -d'+' -f1)
          BUILD_NUMBER=$(echo "$CURRENT" | cut -d'+' -f2)

          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            sed -i "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
            echo "Updated pubspec.yaml to version ${VERSION}+${BUILD_NUMBER}"
          else
            VERSION="$CURRENT_VERSION"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "build_number=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}+${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"

          echo "Version: ${VERSION}"
          echo "Build number: ${BUILD_NUMBER}"
          echo "Tag: v${VERSION}+${BUILD_NUMBER}"

  build-android:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update version in pubspec.yaml
        if: ${{ github.event.inputs.version != '' }}
        working-directory: ./mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_NUMBER="${{ needs.prepare.outputs.build_number }}"
          sed -i "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('mobile/android/**/*.gradle*', 'mobile/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Download ONNX Runtime Android libraries
        run: |
          ORT_VERSION="1.23.2"
          DEST="mobile/android/app/src/main/cpp/onnxruntime/lib"
          ORT_AAR_URL="https://repo1.maven.org/maven2/com/microsoft/onnxruntime/onnxruntime-android/${ORT_VERSION}/onnxruntime-android-${ORT_VERSION}.aar"
          echo "Downloading ONNX Runtime Android ${ORT_VERSION}..."
          curl -fSL -o /tmp/ort.aar "$ORT_AAR_URL"

          # AAR is a zip; extract native libs
          mkdir -p /tmp/ort_extract
          unzip -q /tmp/ort.aar -d /tmp/ort_extract

          # Copy .so files to expected locations
          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            mkdir -p "${DEST}/${ABI}"
            if [ -f "/tmp/ort_extract/jni/${ABI}/libonnxruntime.so" ]; then
              cp "/tmp/ort_extract/jni/${ABI}/libonnxruntime.so" "${DEST}/${ABI}/"
              echo "  Copied ${ABI}/libonnxruntime.so"
            else
              echo "  WARNING: ${ABI}/libonnxruntime.so not found in AAR"
            fi
          done
          echo "ONNX Runtime ${ORT_VERSION} libraries installed."

      - name: Install dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build APK
        working-directory: ./mobile
        run: flutter build apk --release

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: mobile/build/app/outputs/flutter-apk/app-release.apk

  build-ios:
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update version in pubspec.yaml
        if: ${{ github.event.inputs.version != '' }}
        working-directory: ./mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_NUMBER="${{ needs.prepare.outputs.build_number }}"
          sed -i '' "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/ios/Pods
          key: pods-ios-${{ runner.os }}-${{ hashFiles('mobile/ios/Podfile.lock') }}
          restore-keys: |
            pods-ios-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build iOS
        working-directory: ./mobile
        run: flutter build ios --release --no-codesign

      - name: Zip Runner.app
        working-directory: ./mobile/build/ios/iphoneos
        run: zip -r runner-app.zip Runner.app

      - name: Upload iOS app
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: mobile/build/ios/iphoneos/runner-app.zip

  build-macos:
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update version in pubspec.yaml
        if: ${{ github.event.inputs.version != '' }}
        working-directory: ./mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_NUMBER="${{ needs.prepare.outputs.build_number }}"
          sed -i '' "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: mobile/macos/Pods
          key: pods-macos-${{ runner.os }}-${{ hashFiles('mobile/macos/Podfile.lock') }}
          restore-keys: |
            pods-macos-${{ runner.os }}-

      - name: Install dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build macOS
        working-directory: ./mobile
        run: flutter build macos --release

      - name: Zip macOS app
        working-directory: ./mobile/build/macos/Build/Products/Release
        run: zip -r go-strategy-macos.zip go_strategy_app.app

      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: mobile/build/macos/Build/Products/Release/go-strategy-macos.zip

  build-windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update version in pubspec.yaml
        if: ${{ github.event.inputs.version != '' }}
        working-directory: ./mobile
        shell: pwsh
        run: |
          $VERSION = "${{ needs.prepare.outputs.version }}"
          $BUILD_NUMBER = "${{ needs.prepare.outputs.build_number }}"
          (Get-Content pubspec.yaml) -replace '^version: .*', "version: ${VERSION}+${BUILD_NUMBER}" | Set-Content pubspec.yaml

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build Windows
        working-directory: ./mobile
        run: flutter build windows --release

      - name: Zip Windows build
        working-directory: ./mobile/build/windows/x64/runner
        shell: pwsh
        run: Compress-Archive -Path Release/* -DestinationPath go-strategy-windows.zip

      - name: Upload Windows app
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: mobile/build/windows/x64/runner/go-strategy-windows.zip

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update version in pubspec.yaml
        if: ${{ github.event.inputs.version != '' }}
        working-directory: ./mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_NUMBER="${{ needs.prepare.outputs.build_number }}"
          sed -i "s/^version: .*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ninja-build libgtk-3-dev libsecret-1-dev libjsoncpp-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Enable Linux desktop support
        working-directory: ./mobile
        run: flutter create --platforms=linux .

      - name: Install dependencies
        working-directory: ./mobile
        run: flutter pub get

      - name: Build Linux
        working-directory: ./mobile
        run: flutter build linux --release

      - name: Zip Linux build
        working-directory: ./mobile/build/linux/x64/release
        run: tar -czf "${{ github.workspace }}/linux-app.tar.gz" bundle/

      - name: Upload Linux app
        uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: linux-app.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: [prepare, build-android, build-ios, build-macos, build-windows, build-linux]
    steps:
      - uses: actions/checkout@v4

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts/android

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-app
          path: artifacts/ios

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-app
          path: artifacts/windows

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-app
          path: artifacts/linux

      - name: Rename release assets
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          mv artifacts/android/app-release.apk artifacts/go-strategy-app-android-v${VERSION}.apk
          mv artifacts/ios/runner-app.zip artifacts/go-strategy-app-ios-v${VERSION}.zip
          mv artifacts/macos/go-strategy-macos.zip artifacts/go-strategy-app-macos-v${VERSION}.zip
          mv artifacts/windows/go-strategy-windows.zip artifacts/go-strategy-app-windows-v${VERSION}.zip
          mv artifacts/linux/linux-app.tar.gz artifacts/go-strategy-app-linux-v${VERSION}.tar.gz

      - name: Create tag and push
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Delete existing tag if it exists (for re-releases)
          git push origin :refs/tags/"$TAG" 2>/dev/null || true
          git tag -f "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
          BUILD_NUMBER: ${{ needs.prepare.outputs.build_number }}
          TAG: ${{ needs.prepare.outputs.tag }}
          BUILD_NOTES: ${{ github.event.inputs.build_notes }}
        run: |
          NOTES="## Release v${VERSION}+${BUILD_NUMBER}"
          if [ -n "$BUILD_NOTES" ]; then
            NOTES="${NOTES}

          ${BUILD_NOTES}"
          fi
          NOTES="${NOTES}

          ### Assets
          - **Android**: go-strategy-app-android-v${VERSION}.apk
          - **iOS**: go-strategy-app-ios-v${VERSION}.zip (unsigned Runner.app)
          - **macOS**: go-strategy-app-macos-v${VERSION}.zip
          - **Windows**: go-strategy-app-windows-v${VERSION}.zip
          - **Linux**: go-strategy-app-linux-v${VERSION}.tar.gz"

          # Delete existing release if re-releasing same version
          gh release delete "$TAG" --yes 2>/dev/null || true

          gh release create "$TAG" \
            --title "Release v${VERSION}+${BUILD_NUMBER}" \
            --notes "$NOTES" \
            artifacts/go-strategy-app-android-v${VERSION}.apk \
            artifacts/go-strategy-app-ios-v${VERSION}.zip \
            artifacts/go-strategy-app-macos-v${VERSION}.zip \
            artifacts/go-strategy-app-windows-v${VERSION}.zip \
            artifacts/go-strategy-app-linux-v${VERSION}.tar.gz
