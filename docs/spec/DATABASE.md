# Database Specification

**Version**: 1.0
**Last Updated**: 2026-02-12

本文件詳細說明 Go Strategy App 的資料庫架構、Schema 定義、索引策略與資料生命週期。

---

## 1. 資料儲存概覽 (Storage Overview)

Go Strategy App 使用多層資料儲存策略，在不同平台上搭配不同的資料來源：

| 資料層 | 格式 | 位置 | 用途 |
|--------|------|------|------|
| **Opening Book** | JSON (gzip) | `mobile/assets/opening_book.json.gz` | App 內建離線資料，隨安裝包發行 |
| **Analysis Cache** | SQLite | `data/analysis.db` (Server) / App sandbox (Mobile) | 主要分析快取資料庫 |
| **Game Records** | SQLite | App sandbox `game_records.db` (Mobile only) | 棋譜紀錄與雲端同步 |

### 資料查詢優先順序

```
1. Opening Book (bundled JSON)     -- 最快，記憶體內查詢
       |
       v  (miss)
2. Local Analysis Cache (SQLite)   -- 本地磁碟查詢
       |
       v  (miss)
3. Local KataGo Engine             -- 即時 AI 運算
```

---

## 2. 資料庫檔案 (Database Files)

### 2.1 Server 端：`data/analysis.db`

- **用途**：Opening Book JSON 的源資料，也供 Python 資料生成工具使用
- **位置**：專案根目錄下 `data/analysis.db`，由 `config.yaml` 中 `database.path` 設定
- **大小**：約 14 MB（含 31,590 筆紀錄）
- **管理**：由 Python `AnalysisCache` class 管理 (`src/cache.py`)

### 2.2 Mobile 端：`analysis_cache.db`

- **用途**：App 本地分析快取，初始資料從 bundled DB 複製
- **位置**：
  - Desktop (macOS/Windows/Linux)：`getApplicationSupportDirectory()` 下
  - Mobile (iOS/Android)：`getDatabasesPath()` 下
- **初始化**：首次啟動時從 `assets/data/analysis.db` 複製 bundled 資料
- **管理**：由 Dart `CacheService` class 管理 (`mobile/lib/services/cache_service.dart`)

### 2.3 Mobile 端：`game_records.db`

- **用途**：棋譜本地儲存與雲端同步狀態追蹤
- **位置**：`getDatabasesPath()` 下
- **管理**：由 Dart `GameRecordService` class 管理 (`mobile/lib/services/game_record_service.dart`)

---

## 3. Table Definitions

### 3.1 `analysis_cache` — 分析快取主表

儲存 KataGo 分析結果，以 Zobrist Hash 作為棋盤局面的唯一識別。

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 自動遞增主鍵 |
| `board_hash` | TEXT | NOT NULL, Indexed | Zobrist Hash（16 位 hex），標準化後的棋盤局面雜湊值 |
| `moves_sequence` | TEXT | Nullable | 著手序列，格式：`B[Q16];W[D4];B[Q3]` |
| `board_size` | INTEGER | NOT NULL | 棋盤大小：9, 13, 或 19 |
| `komi` | REAL | NOT NULL | 貼目值（如 7.5, 0.5） |
| `analysis_result` | TEXT | NOT NULL | Top moves 的 JSON 陣列（見 3.1.1） |
| `engine_visits` | INTEGER | NOT NULL | KataGo 搜尋的 visits 數 |
| `model_name` | TEXT | NOT NULL | 所用 Neural Network 模型名稱 |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 建立時間（ISO 8601 格式） |
| `calculation_duration` | REAL | Nullable | 計算耗時（秒） |
| `stopped_by_limit` | INTEGER | Nullable | 0 = 自然收斂，1 = 被時間/visits 限制中止 |
| `limit_setting` | TEXT | Nullable | 限制設定描述，如 `"5s"`, `"100v"` |
| `ownership` | TEXT | Nullable | 領地估算 JSON 陣列，每個交叉點 -1.0 ~ 1.0 |

#### 3.1.1 `analysis_result` JSON 格式

`analysis_result` 欄位儲存候選著手的 JSON 陣列：

```json
[
  {
    "move": "Q16",
    "winrate": 0.523,
    "score_lead": 1.2,
    "visits": 150
  },
  {
    "move": "D4",
    "winrate": 0.518,
    "score_lead": 0.8,
    "visits": 120
  }
]
```

| Field | Type | Description |
|-------|------|-------------|
| `move` | string | GTP 座標格式（如 `"Q16"`，字母 `I` 被跳過） |
| `winrate` | float | 黑方勝率（0.0 ~ 1.0），始終以黑方視角表示 |
| `score_lead` | float | 黑方的領先目數（正數 = 黑方領先） |
| `visits` | int | 此候選著手的搜尋次數 |

#### 3.1.2 `ownership` JSON 格式

棋盤上每個交叉點的領地歸屬估算，以一維陣列儲存（長度 = `board_size * board_size`）：

```json
[-1.0, -0.95, ..., 0.0, ..., 0.88, 1.0]
```

- `1.0` = 完全屬於黑方
- `-1.0` = 完全屬於白方
- `0.0` = 中立

#### 3.1.3 `stopped_by_limit` 欄位說明

SQLite 不支援 BOOLEAN 型別，因此使用 INTEGER 表示：

| 值 | 含義 |
|----|------|
| `NULL` | 未記錄（舊資料或 Opening Book 匯入） |
| `0` | 分析自然收斂（結果品質高） |
| `1` | 被 visits/時間限制中止（結果可能不完整） |

### 3.2 `opening_book_meta` — Opening Book 元資料表

記錄已完成的 Opening Book 建置狀態，用於判斷特定配置是否已有完整的預算資料。

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY AUTOINCREMENT | 自動遞增主鍵 |
| `board_size` | INTEGER | NOT NULL | 棋盤大小 |
| `komi` | REAL | NOT NULL | 貼目值 |
| `handicap` | INTEGER | NOT NULL | 讓子數（0 = 無讓子） |
| `visits` | INTEGER | NOT NULL | 分析使用的 visits 數 |
| `depth` | INTEGER | NOT NULL | BFS 搜尋深度 |
| `completed_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 建置完成時間 |
| `notes` | TEXT | Nullable | 備註（如 `"Generated by script, 5000 nodes"`） |

### 3.3 `game_records` — 棋譜紀錄表 (Mobile Only)

僅存在於 Mobile App 的 `game_records.db` 中，用於本地棋譜管理及雲端同步。

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | TEXT | PRIMARY KEY | UUID，棋譜唯一識別 |
| `name` | TEXT | NOT NULL | 棋譜名稱 |
| `board_size` | INTEGER | NOT NULL | 棋盤大小（9, 13, 19） |
| `komi` | REAL | NOT NULL | 貼目值 |
| `handicap` | INTEGER | NOT NULL, DEFAULT 0 | 讓子數 |
| `moves` | TEXT | NOT NULL | 著手列表 JSON |
| `created_at` | TEXT | NOT NULL | 建立時間（ISO 8601） |
| `modified_at` | TEXT | NOT NULL | 最後修改時間（ISO 8601） |
| `status` | TEXT | NOT NULL | 同步狀態：`local`, `synced`, `pendingUpload` |
| `cloud_provider` | TEXT | NOT NULL | 雲端服務提供者：`none`, `google`, etc. |
| `cloud_file_id` | TEXT | Nullable | 雲端檔案 ID |
| `cloud_etag` | TEXT | Nullable | 雲端檔案 ETag（衝突偵測） |
| `black_player` | TEXT | Nullable | 黑方棋手名稱 |
| `white_player` | TEXT | Nullable | 白方棋手名稱 |
| `result` | TEXT | Nullable | 對局結果（如 `"B+3.5"`, `"W+R"`） |
| `event` | TEXT | Nullable | 比賽名稱 |
| `notes` | TEXT | Nullable | 使用者備註 |

---

## 4. Index Strategy（索引策略）

### 4.1 `analysis_cache` 索引

```sql
-- 一般查詢索引：加速 board_hash 查詢
CREATE INDEX IF NOT EXISTS idx_board_hash
  ON analysis_cache(board_hash);

-- 複合唯一索引：防止同一局面、同一 visits、同一 komi 重複寫入
CREATE UNIQUE INDEX IF NOT EXISTS idx_board_hash_visits_komi
  ON analysis_cache(board_hash, engine_visits, komi);
```

**設計原理**：

| 索引 | 目的 |
|------|------|
| `idx_board_hash` | 加速以 hash 為條件的查詢（`get()` 方法） |
| `idx_board_hash_visits_komi` | 唯一約束，確保 `(hash, visits, komi)` 組合唯一。允許同一局面在不同 visits 設定下儲存多筆結果 |

**為何不只用 `board_hash` 作唯一鍵**：同一局面可能在不同 visits 設定下有不同精度的分析結果（如 100v 與 500v），需要同時保留。

### 4.2 `opening_book_meta` 索引

```sql
-- 複合唯一索引：防止同一配置重複記錄
CREATE UNIQUE INDEX IF NOT EXISTS idx_opening_book_meta
  ON opening_book_meta(board_size, komi, handicap, visits);
```

### 4.3 `game_records` 索引

此表以 `id` (TEXT PRIMARY KEY) 為主鍵，SQLite 自動建立主鍵索引。目前無額外索引。未來若查詢效能不足，可考慮加入 `modified_at` 索引以加速排序。

---

## 5. SQLite 設定 (SQLite Configuration)

### 5.1 WAL Mode

```python
conn.execute("PRAGMA journal_mode=WAL")
conn.execute("PRAGMA synchronous=NORMAL")
```

- **WAL (Write-Ahead Logging)**：允許讀寫並行，大幅改善多執行緒存取效能
- **synchronous=NORMAL**：在 WAL 模式下提供良好的耐久性與效能平衡

### 5.2 Connection 設定

```python
conn = sqlite3.connect(str(self.db_path), timeout=60)
conn.row_factory = sqlite3.Row
```

- **timeout=60**：等待 database lock 最多 60 秒，避免 `build_opening_book.py` 長時間寫入時其他 reader 失敗
- **row_factory=sqlite3.Row**：以 dict-like 物件回傳查詢結果

### 5.3 Mobile 端差異

| 設定項 | Server (Python) | Mobile (Dart/sqflite) |
|--------|-----------------|----------------------|
| Library | `sqlite3` (stdlib) | `sqflite` + `sqflite_common_ffi` (Desktop) |
| WAL Mode | 手動設定 PRAGMA | 由 sqflite 預設管理 |
| Connection Pool | 每次操作建立新連線 | 單一持久連線 (`openDatabase`) |
| FFI Init | N/A | Desktop 平台需 `sqfliteFfiInit()` |

---

## 6. 資料生命週期 (Data Lifecycle)

### 6.1 Analysis Cache 資料流

```
                    ┌────────────────────┐
                    │  KataGo Book       │
                    │  (tar.gz HTML)     │
                    └────────┬───────────┘
                             │ import_katago_book.py
                             v
┌────────────────────────────────────────────────┐
│             analysis.db (Server)                │
│  analysis_cache + opening_book_meta             │
└────────┬───────────────────────┬───────────────┘
         │ export_opening_book.py│ bundled copy
         v                      v
┌─────────────────┐   ┌─────────────────────────┐
│ opening_book    │   │ analysis_cache.db        │
│ .json.gz        │   │ (Mobile, initial data)   │
│ (App Asset)     │   └───────────┬──────────────┘
└────────┬────────┘               │ runtime writes
         │ load to memory         v
         v                ┌─────────────────────────┐
┌─────────────────┐       │ analysis_cache.db        │
│ OpeningBookSvc  │       │ (Mobile, with user data) │
│ (in-memory map) │       └──────────────────────────┘
└─────────────────┘
```

### 6.2 寫入合併策略 (Merge Logic)

`AnalysisCache.put()` 在寫入時使用智慧合併邏輯，避免低品質結果覆蓋高品質結果：

```
Priority 1: Completeness（完整性）
  - Complete (stopped_by_limit=False) 永遠覆蓋 Partial (True)
  - Partial 不會覆蓋 Complete

Priority 2: Effort（運算量）
  - 相同完整性時，保留耗時較長的結果（10% 容忍度）

Priority 3: Recency（新鮮度）
  - 類似運算量時，偏好較新的結果
```

`INSERT OR REPLACE` 搭配 `idx_board_hash_visits_komi` 唯一索引，在寫入前先查詢既有資料並比較。

### 6.3 Database Merge（跨資料庫合併）

`AnalysisCache.merge_database()` 支援將另一個 SQLite 資料庫合併進來：

- **相同 `(hash, visits, komi)`**：對匹配的著手取 winrate 和 score_lead 的平均值
- **不同組合**：直接插入
- 合併後的 model_name 會加上 `+merged` 後綴

### 6.4 資料過期

目前 **沒有自動過期機制**。分析結果不會隨時間失效（圍棋局面的最佳著手不會改變）。手動清理可透過：

```python
cache.clear()        # 清除所有快取
cache.delete(hash)   # 刪除特定局面
```

---

## 7. Opening Book JSON 格式

Opening Book 是從 `analysis.db` 匯出的壓縮 JSON 檔案，內建於 App 中供離線使用。

### 7.1 檔案結構

```json
{
  "version": 2,
  "generated_at": "2026-02-10T15:30:00",
  "stats": {
    "total_entries": 31590,
    "by_board_size": {"9": 10230, "13": 8543, "19": 12817},
    "min_visits": 50,
    "filtered_dead_moves": 1234
  },
  "entries": [
    {
      "h": "a1b2c3d4e5f60718",
      "s": 9,
      "k": 7.5,
      "m": "B[E5];W[C3]",
      "t": [
        {"move": "G7", "winrate": 0.52, "scoreLead": 1.2, "visits": 500}
      ],
      "v": 500
    }
  ]
}
```

### 7.2 Entry 欄位對照

| JSON Key | Full Name | Type | Description |
|----------|-----------|------|-------------|
| `h` | hash | string | Zobrist Hash（非 canonical，因已展開對稱） |
| `s` | board_size | int | 棋盤大小 |
| `k` | komi | float | 貼目值 |
| `m` | moves_sequence | string | 著手序列：`B[E5];W[C3]` |
| `t` | top_moves | array | 候選著手陣列 |
| `v` | visits | int | engine_visits |

### 7.3 匯出流程

```bash
# 從 analysis.db 匯出（含 gzip 壓縮，過濾無後續資料的死路著手）
python -m src.scripts.export_opening_book --compress --min-visits 50
```

匯出時會：
1. 展開所有 8 種對稱變換，生成每個局面的 8 個 entry
2. 過濾 dead moves（沒有後續資料的著手）
3. 以 `size:komi:moves_sequence` 為 key 去重

### 7.4 匯入 KataGo Book

```bash
# 從 KataGo 官方 book 匯入到 analysis.db
python -m src.scripts.import_katago_book \
  --book-path katago/books/book9x9tt-20241105.tar.gz \
  --min-visits 10000
```

**KataGo winrate 轉換**：KataGo book 的 `wl` 欄位是對手勝率，匯入時需轉換：

```python
winrate = 1.0 - wl  # 轉為己方勝率
# 若當前玩家是白方，再翻轉為黑方視角：
if next_player == 'W':
    winrate = 1.0 - winrate
    score_lead = -score_lead
```

---

## 8. Zobrist Hash 說明

Board hash 是快取查詢的核心 key，使用 Zobrist Hashing 演算法：

### 8.1 Hash 計算要素

| 要素 | 方法 | 說明 |
|------|------|------|
| 棋子位置 | XOR `stone_hash[color][x][y]` | 每顆棋子 XOR 進 hash |
| 下一手玩家 | XOR `player_hash` if White | 區分黑先/白先 |
| 貼目 | XOR `komi_hash[quantized_komi]` | 量化為 0.5 的倍數 |
| 棋盤大小 | XOR `size_hash[board_size]` | 避免不同棋盤大小的空盤碰撞 |

### 8.2 Canonical Hash（對稱正規化）

為提高快取命中率，使用 D4 二面體群（8 種對稱變換）進行正規化：

1. 對當前局面施加 8 種變換（4 旋轉 + 4 鏡像）
2. 計算每種變換的 hash
3. 取最小 hash 作為 canonical hash

這使得對稱等價的局面共享同一個 hash，快取效率提升最多 8 倍。

### 8.3 Hash 格式

- 64-bit integer，以 16 位 hex string 儲存（如 `"a1b2c3d4e5f60718"`）
- 固定種子 `ZOBRIST_SEED = 42` 確保跨平台 hash 值一致

---

## 9. Schema Migration（Schema 遷移）

`AnalysisCache._init_db()` 在每次初始化時自動偵測並執行必要的遷移：

### 9.1 遷移歷史

| 遷移 | 觸發條件 | 操作 |
|------|----------|------|
| **Single-hash to Multi-visit** | `board_hash` 有單獨的 UNIQUE 約束 | 重建表，改用 `(board_hash, engine_visits, komi)` 複合唯一索引 |
| **Add Komi to Unique Index** | 唯一索引只有 `(board_hash, engine_visits)` 無 `komi` | 刪除舊索引，建立含 komi 的新索引 |
| **Phase 3 Columns** | 缺少 `calculation_duration`, `stopped_by_limit`, `limit_setting`, `ownership` 欄位 | `ALTER TABLE ADD COLUMN` 逐一新增 |

### 9.2 遷移策略

- 使用 `PRAGMA table_info()` 和 `PRAGMA index_list()` 偵測現有 schema
- 涉及索引變更時使用 `DROP INDEX` + `CREATE INDEX`
- 涉及表結構變更時使用 rename-copy-drop 模式
- Seed data：新建資料庫時自動載入 `src/assets/seed_data.sql`（若存在）

---

## 10. 管理工具 (Management Scripts)

| Script | 用途 | 指令 |
|--------|------|------|
| `build_opening_book.py` | BFS 建置 Opening Book（呼叫 KataGo 運算） | `python -m src.scripts.build_opening_book --visits 500 --depth 10` |
| `import_katago_book.py` | 匯入 KataGo 官方 book | `python -m src.scripts.import_katago_book --book-path <path>` |
| `export_opening_book.py` | 從 DB 匯出 JSON 給 App 使用 | `python -m src.scripts.export_opening_book --compress` |
| `export_db.py` | 匯出 DB 為 SQL seed file | `python -m src.scripts.export_db` |
| `verify_database.py` | 驗證 DB 健康狀態 | `python -m src.scripts.verify_database` |

---

## 11. 目前資料量統計

截至最後一次更新：

| 棋盤大小 | 筆數 | Visits | 貼目 |
|----------|------|--------|------|
| 9x9 | 10,230 | 500v | 7.5 |
| 13x13 | 8,543 | 500v | 7.5 |
| 19x19 | 12,817 | 500v | 7.5 |
| **合計** | **31,590** | | |

資料庫檔案大小：約 14 MB
